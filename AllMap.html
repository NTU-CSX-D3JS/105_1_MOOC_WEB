<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Map - Working x Renting</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
    <script src="https://googlemaps.github.io/js-info-bubble/src/infobubble.js"></script>
    <script src="./js/jquery-sidebar.min.js"></script>
    <link rel="stylesheet" href="./css/gmaps-sidebar.min.css" />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
#map {
  height: 100%;
}
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}
    </style>
  </head>
  <body>
  <div id="map" class="sidebar-map"></div>
  <div id="sidebar" class="sidebar collapsed">
    <!-- Nav tabs -->
    <div class="sidebar-tabs">
      <ul role="tablist">
        <li><a href="#workfilter" role="tab"><i class="fa fa-filter"   ></i></a></li>
        <li><a href="#homefilter" role="tab"><i class="fa fa-filter"   ></i></a></li>
        <li><a href="./index.html"role="tab"><i class="fa fa-home"     ></i></a></li>
      </ul>

      <ul role="tablist">
        <li><a href="#copy" role="tab"><i class="fa fa-creative-commons"></i></a></li>
      </ul>
    </div>

    <!-- Tab panes -->
    <div class="sidebar-content">
      <div class="sidebar-pane" id="workfilter">
        <h1 class="sidebar-header">
          薪水篩選
          <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
        </h1>
        <form id="myselect">
          <ul>
            <li>無面議  :<input type="checkbox" id="novalue" checked=false></li>
            <li>時薪下限:<input type="number" id="hourlow"  value=0 ></li>
            <li>時薪上限:<input type="number" id="hourhigh" value='2147483647' ></li>
            <li>日薪下限:<input type="number" id="daylow"   value=0 ></li>
            <li>日薪上限:<input type="number" id="dayhigh"  value='2147483647' ></li>
            <li>月薪下限:<input type="number" id="monthlow" value=0 ></li>
            <li>月薪上限:<input type="number" id="monthhigh"value='2147483647' ></li>
            <input type="button" onClick="selectSet()" value="確認修改">
          </ul>
          <!-- be careful for wrong input -->
        </form>
      </div>
      <div class="sidebar-pane" id="homefilter">
        <h1 class="sidebar-header">
          房屋篩選  
          <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
        </h1>
        <form id="myselect">
          <ul>
            <li>房租下限:<input type="number" id="rentlow"  value=0 ></li>
            <li>房租上限:<input type="number" id="renthigh" value='2147483647' ></li>
            <li>坪數下限:<input type="number" id="arealow"   value=0 ></li>
            <li>坪數上限:<input type="number" id="areahigh"  value='2147483647' ></li>
            <input type="button" onClick="selectSet()" value="確認修改">
          </ul>
          <!-- be careful for wrong input -->
        </form>
      </div>
      <div class="sidebar-pane" id="copy">
        <h1 class="sidebar-header">
          Creative Commons
          <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
        </h1>
        <img src="./images/work.svg" style="width:100px"/>
        <div>Icons made by <a href="http://www.flaticon.com/authors/icomoon" title="Icomoon">Icomoon</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>
        <img src="./images/home.svg" style="width:100px"/>
        <div>Icons made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>
        <p> 全台各鄉鎮區行政區界及範圍 </p>
        <a href="https://gist-map.motc.gov.tw/Complex/MapTopic" target="_blank"><img src="http://data.gov.tw/sites/all/themes/execute_responsive_theme/logo.png" alt="" style="width:270px"></a>
        <p> Google map sidebar </p>
        <a href="https://github.com/Turbo87/sidebar-v2" target="_blank"><i class="fa fa-github fa-5x"></i></a>

      </div>
    </div>
  </div>
  <script>
var map;
var workdata, homedata;

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 14,
    center: {lat: 25.044444, lng: 121.5234511},
  });

  areaDraw()
}

function initRead(){
  var sidebar = $('#sidebar').sidebar();
  console.log(sidebar)
  selectSet()
  $.get('./data/518_Taipei_ok.csv', function(data) {
    workdata = $.csv.toObjects(data)
    $.get('./data/591_Taipei_ok.csv', function(data) {
      homedata = $.csv.toObjects(data)
      initMap()
    },"text")
  },"text")
}

var area_click = {}
function areaDraw(){
  map.data.loadGeoJson( './data/MapLines.json');

  map.data.setStyle(function(feature) {
    var dc = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#e377c2', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
    return {
      fillColor: dc[feature.f.townid%10],
      fillOpacity: 0.2,
      strokeWeight: 0.5
    }
  });
  map.data.addListener('mouseover', function(event) {
    map.data.overrideStyle(event.feature, {strokeWeight: 8});
  });

  map.data.addListener('mouseout', function(event) {
    map.data.overrideStyle(event.feature, {strokeWeight: .5});
  });
  map.data.addListener('click', function(event) {
    name = event.feature.f.townname
    if( area_click[name] ){
      map.data.overrideStyle(event.feature, {fillOpacity: 0.2});
      delMark(name)
      delete area_click[name]
    }
    else{
      map.data.overrideStyle(event.feature, {fillOpacity: 0.8});
      area_click[name] = []
      workMark(name)
      homeMark(name)
    }
  });
}

function moneyStr(a){
  return a['薪資待遇']
}

var preWindow = false
var t = 100;
var select = {}

function selectSet(){
  var name = ['hourlow','hourhigh','daylow','dayhigh','monthlow','monthhigh',
    'rentlow','renthigh','arealow','areahigh' ] 
  name.forEach( function(n){
    select[n] = +document.getElementById(n).value
  })
  select['novalue'] = document.getElementById("novalue").checked

  // refresh data
  for(var name in area_click){
    delMark(name)
    area_click[name] = []
    workMark(name)
    homeMark(name)
  }
}

function delMark(name){
  area_click[name].forEach( function(marker){
    marker.setMap(null);
  })
}

function setMark(data,name,img,filt,cont) {
  t=1000;
  data.forEach( function(result){
    if(result.lng == 'NA' || result.lng.trim() =='')
      return ;
    if(result.section_name+"區" != name) 
      return ;
    if(--t<0) //test
      return ;
    if( !filt(result) )
      return ;

    var latlng = new google.maps.LatLng(result.lat, result.lng)
    var marker = new google.maps.Marker({
      position: latlng,
      map: map,
      icon: new google.maps.MarkerImage(img,
        null, null, null, new google.maps.Size(17,17)),
    });
    area_click[name].push(marker)
    marker.addListener('click', function() {
      var infowindow = new InfoBubble({
        map: map,
        content: cont(result),
        position: latlng,
        shadowStyle: 1,
        padding: 10,
        borderRadius: 10,
        arrowSize: 10,
        borderWidth: 1,
        borderColor: '#2c2c2c',
        backgroundColor: 'rgba(255,255,255,0.87)',
        disableAutoPan: true,
        arrowPosition: 30,
        arrowStyle: 1,
        opacity: 0.7
      });
      infowindow.open(map, marker);
      if(preWindow != false)
        preWindow.close()
      preWindow = infowindow
    });
  })
}


function homeMark(name) { setMark(
  homedata,
  name,
  './images/home.svg',
  function(result){
    var item=['price','area']
    for(var i in item){
      key = item[i]
      if( select[key+'low'] > +result[key] ) 
        return false;
      else  if( select[key+'high'] < +result[key] ) 
        return false;
    }
    return true;
  },
  function(result){return "<div><h3>"+result.title+"</h3>"+
    "<p>"+result.layout+"</p>" + 
    "<p>"+result.area+"坪</p>" + 
    "<p>月租 NT"+result.price+"</p>" + 
    "<a target='_blank' href='"+result.URL+"'>591_LINK</a>"+
    "</div>"
  }
)}

function workMark(name) { setMark(
  workdata,
  name,
  './images/work.svg',
  function(result){
    var na=0;
    var item = ['hourlow','hourhigh','daylow','dayhigh','monthlow','monthhigh']
    for(var i in item){
      key = item[i]
      if(result[key] == 'NA'){
        ++na;
      }
      else if( result[key] == '+'){
        if( key.search("low")>-1) {
          if(+result[key.slice(0,-3)+"high"] < select[key])
            return false;
        }
        else{
          if(+result[key.slice(0,-4)+"low"] > select[key])
            return false;
        }
      }
      else if( key.search("low")>-1) {
        if(+result[key] < select[key])
          return false;
      }
      else if( key.search("high")>-1){
        if(+result[key] > select[key])
          return false;
      }
      else
        console.log(select)
    }
    if(na==6 && select['novalue'] == true) // no money
      return false;
    return true;
  },
  function(result){ return "<div><h3>"+result.title+"</h3>"+
    "<h4>"+moneyStr(result)+"</h4>" + 
    "<a target='_blank' href='"+result.URL+"'>518_LINK</a>"+
    "</div>"
  }
)}
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDePj2nW03TgZAQK2G95OQFv3JMGHMfvxo&libraries=visualization&callback=initRead"> </script>


  </body>
</html>

